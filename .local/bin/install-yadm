#!/bin/sh

# Start
dnf check-update

# Configure Zsh
sudo dnf install -y zsh

if [ "$SHELL" != "$(which zsh)" ]; then
  chsh -s $(which zsh)
  echo "Shell changed to zsh."
  rm -f ~/.z* # remove the stuff that will be pulled from git
else
  echo "You are already using zsh."
fi

# Add ssh keys
SSH_DIR="$HOME/.ssh"
mkdir -p "$SSH_DIR"
cd "$SSH_DIR" 
echo "Waiting for the user to get an SSH key from an external hardware key"
while true; do
    if ssh-add -L > /dev/null 2>&1; then
        echo "SSH key(s) are loaded!"
        break
    fi
    ssh-keygen -K 	
done
cd -

# Install yadm in a Fedora system and clone the dotfiles repo
sudo dnf config-manager addrepo --from-repofile=https://download.opensuse.org/repositories/home:TheLocehiliosan:yadm/Fedora_42/home:TheLocehiliosan:yadm.repo
sudo dnf install -y yadm

export GIT_SSH_COMMAND="ssh -o IdentityAgent=none -o IdentitiesOnly=yes -i $SSH_DIR/id_ed25519_sk_rk"
yadm clone git@github.com:josbarros/dotfiles.git
yadm gitconfig user.email "joserui@joseruibarros.com"
yadm gitconfig user.name "Jos√© Rui Barros"

# Finish off
rm -rf ~/.gnupg ~/.bash*
echo "Please log off now."
